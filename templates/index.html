{% extends "base.html" %}

{% block title %}CPA Study Agent - Home{% endblock %}

{% block content %}
<!-- Practice Questions Tab -->
<div class="tab-pane fade show active" id="practice" role="tabpanel">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-question-circle me-2"></i>Practice Questions
                    </h5>
                    <p class="card-text">Get a random practice question and receive AI-powered feedback on your answer.</p>
                    
                    <div class="mb-3">
                        <button id="getQuestionBtn" class="btn btn-primary">
                            <i class="fas fa-random me-2"></i>Get Random Question
                        </button>
                    </div>
                    
                    <div class="mb-3">
                        <label for="questionText" class="form-label">Question:</label>
                        <textarea class="form-control" id="questionText" rows="5" readonly placeholder="Click 'Get Random Question' to start..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="answerInput" class="form-label">Your Answer:</label>
                        <textarea class="form-control" id="answerInput" rows="4" placeholder="Type your answer here..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <button id="checkAnswerBtn" class="btn btn-primary" disabled>
                            <i class="fas fa-check me-2"></i>Check Answer
                        </button>
                    </div>
                    
                    <div class="mb-3">
                        <label for="feedbackOutput" class="form-label">Feedback:</label>
                        <textarea class="form-control" id="feedbackOutput" rows="8" readonly placeholder="Your feedback will appear here..."></textarea>
                    </div>
                    
                    <div id="practiceLoading" class="loading">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Processing...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom Question Tab -->
<div class="tab-pane fade" id="custom" role="tabpanel">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-search me-2"></i>Ask Custom Question
                    </h5>
                    <p class="card-text">Ask any question about Tax Court topics and get AI-powered answers with source references.</p>
                    
                    <div class="mb-3">
                        <label for="customQuestion" class="form-label">Your Question:</label>
                        <textarea class="form-control" id="customQuestion" rows="3" placeholder="What would you like to know about Tax Court?"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <button id="askQuestionBtn" class="btn btn-primary">
                            <i class="fas fa-paper-plane me-2"></i>Ask Question
                        </button>
                    </div>
                    
                    <div class="mb-3">
                        <label for="customAnswer" class="form-label">Answer:</label>
                        <textarea class="form-control" id="customAnswer" rows="10" readonly placeholder="The answer will appear here..."></textarea>
                    </div>
                    
                    <div id="customLoading" class="loading">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Thinking...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Document Management Tab -->
<div class="tab-pane fade" id="docs" role="tabpanel">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-file-alt me-2"></i>Document Management
                    </h5>
                    <p class="card-text">Manage your PDF textbooks and database. Ingest documents to enable AI-powered responses.</p>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <button id="ingestBtn" class="btn btn-primary w-100">
                                <i class="fas fa-upload me-2"></i>Ingest Documents
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button id="statusBtn" class="btn btn-secondary w-100">
                                <i class="fas fa-info-circle me-2"></i>Check Status
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button id="clearBtn" class="btn btn-secondary w-100">
                                <i class="fas fa-trash me-2"></i>Clear Database
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="statusOutput" class="form-label">Status:</label>
                        <textarea class="form-control" id="statusOutput" rows="4" readonly placeholder="Click 'Check Status' to see current database status..."></textarea>
                    </div>
                    
                    <div id="docsLoading" class="loading">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Processing...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- About Tab -->
<div class="tab-pane fade" id="about" role="tabpanel">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-info-circle me-2"></i>About This Application
                    </h5>
                    
                    <div class="mb-4">
                        <p>This is an AI-powered study assistant designed to help you prepare for the Tax Court exam.</p>
                    </div>
                    
                    <h6><i class="fas fa-star me-2"></i>Features:</h6>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check text-success me-2"></i>Practice with randomly generated questions</li>
                        <li><i class="fas fa-check text-success me-2"></i>Get detailed feedback on your answers</li>
                        <li><i class="fas fa-check text-success me-2"></i>Ask custom questions about Tax Court topics</li>
                        <li><i class="fas fa-check text-success me-2"></i>Document ingestion and retrieval with ChromaDB</li>
                        <li><i class="fas fa-check text-success me-2"></i>AI-powered responses using OpenAI GPT-3.5-turbo</li>
                    </ul>
                    
                    <h6><i class="fas fa-play me-2"></i>How to use:</h6>
                    <ol>
                        <li>Click "Get Random Question" to practice</li>
                        <li>Type your answer and click "Check Answer"</li>
                        <li>Use the "Ask Custom Question" tab for specific topics</li>
                        <li>Use "Document Management" to ingest your PDF textbooks</li>
                    </ol>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Note:</strong> Make sure to set your OpenAI API key in the environment variables.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Practice Questions
    $('#getQuestionBtn').click(function() {
        $('#practiceLoading').show();
        $('#questionText').val('');
        $('#feedbackOutput').val('');
        
        $.get('/api/random-question')
            .done(function(data) {
                $('#questionText').val(data.text || 'No question available');
                $('#checkAnswerBtn').prop('disabled', false);
            })
            .fail(function(xhr) {
                $('#questionText').val('Error: Could not fetch question');
            })
            .always(function() {
                $('#practiceLoading').hide();
            });
    });
    
    $('#checkAnswerBtn').click(function() {
        const question = $('#questionText').val();
        const answer = $('#answerInput').val();
        
        if (!answer.trim()) {
            alert('Please enter an answer first.');
            return;
        }
        
        $('#practiceLoading').show();
        $('#feedbackOutput').val('');
        
        $.ajax({
            url: '/api/check-answer',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                question: question,
                answer: answer
            })
        })
        .done(function(data) {
            let feedback = data.feedback || 'No feedback available';
            if (data.context_sources && data.context_sources.length > 0) {
                feedback += '\n\nSources: ' + data.context_sources.join(', ');
            }
            $('#feedbackOutput').val(feedback);
        })
        .fail(function(xhr) {
            $('#feedbackOutput').val('Error: Could not check answer');
        })
        .always(function() {
            $('#practiceLoading').hide();
        });
    });
    
    // Custom Questions
    $('#askQuestionBtn').click(function() {
        const question = $('#customQuestion').val();
        
        if (!question.trim()) {
            alert('Please enter a question first.');
            return;
        }
        
        $('#customLoading').show();
        $('#customAnswer').val('');
        
        $.ajax({
            url: '/api/ask-question',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                question: question
            })
        })
        .done(function(data) {
            let answer = data.answer || 'No answer available';
            if (data.context_sources && data.context_sources.length > 0) {
                answer += '\n\nSources: ' + data.context_sources.join(', ');
            }
            $('#customAnswer').val(answer);
        })
        .fail(function(xhr) {
            $('#customAnswer').val('Error: Could not get answer');
        })
        .always(function() {
            $('#customLoading').hide();
        });
    });
    
    // Document Management
    $('#ingestBtn').click(function() {
        $('#docsLoading').show();
        $('#statusOutput').val('');
        
        $.post('/api/ingest-documents')
            .done(function(data) {
                $('#statusOutput').val(data.message || 'Documents ingested successfully');
            })
            .fail(function(xhr) {
                const response = xhr.responseJSON;
                $('#statusOutput').val('Error: ' + (response?.error || 'Unknown error'));
            })
            .always(function() {
                $('#docsLoading').hide();
            });
    });
    
    $('#statusBtn').click(function() {
        $('#docsLoading').show();
        $('#statusOutput').val('');
        
        $.get('/api/ingest-status')
            .done(function(data) {
                const chunks = data.chunks_ingested || 0;
                const files = data.total_pdf_files || 0;
                $('#statusOutput').val(`Status: ${chunks} chunks ingested from ${files} PDF files`);
            })
            .fail(function(xhr) {
                $('#statusOutput').val('Error: Could not check status');
            })
            .always(function() {
                $('#docsLoading').hide();
            });
    });
    
    $('#clearBtn').click(function() {
        if (!confirm('Are you sure you want to clear the database? This will remove all ingested documents.')) {
            return;
        }
        
        $('#docsLoading').show();
        $('#statusOutput').val('');
        
        $.post('/api/clear-database')
            .done(function(data) {
                $('#statusOutput').val(data.message || 'Database cleared successfully');
            })
            .fail(function(xhr) {
                const response = xhr.responseJSON;
                $('#statusOutput').val('Error: ' + (response?.error || 'Unknown error'));
            })
            .always(function() {
                $('#docsLoading').hide();
            });
    });
    
    // Enable Enter key for custom questions
    $('#customQuestion').keypress(function(e) {
        if (e.which == 13 && !e.shiftKey) {
            e.preventDefault();
            $('#askQuestionBtn').click();
        }
    });
});
</script>
{% endblock %} 